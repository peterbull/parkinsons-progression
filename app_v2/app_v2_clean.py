# AUTOGENERATED! DO NOT EDIT! File to edit: ../pb_parkinsons_progression_1.ipynb.

# %% auto 0
__all__ = ['comp', 'path', 'train_peptides', 'train_proteins', 'train_clinical_data', 'supplemental_clinical_data',
           'combined_clinical_data', 'cat_names', 'cont_names', 'procs', 'to', 'preprocessed_data', 'peptide_agg',
           'merged_protein_data', 'merged_data']

from fastai.tabular.all import *

import seaborn as sns

import tqdm

pd.options.display.max_rows = 20
pd.options.display.max_columns = 8

try: import fastkaggle
except ModuleNotFoundError:
    !pip install -Uq fastkaggle

from fastkaggle import *

comp = 'amp-parkinsons-disease-progression-prediction'
path = setup_comp(comp, install='fastai')

train_peptides = pd.read_csv(path/'train_peptides.csv')
train_proteins = pd.read_csv(path/'train_proteins.csv')
train_clinical_data = pd.read_csv(path/'train_clinical_data.csv')
supplemental_clinical_data = pd.read_csv(path/'supplemental_clinical_data.csv')

# Combine train_clinical_data and supplemental_clinical_data
combined_clinical_data = pd.concat([train_clinical_data, supplemental_clinical_data], ignore_index=True)

# Define categorical and continuous variable columns
cat_names = ['patient_id', 'upd23b_clinical_state_on_medication']
cont_names = ['visit_month', 'updrs_1', 'updrs_2', 'updrs_3', 'updrs_4']

# Define the preprocessing steps
procs = [Categorify, FillMissing, Normalize]

# Create a TabularPandas object
to = TabularPandas(combined_clinical_data, procs, cat_names, cont_names, splits=None)

# Apply the preprocessing steps
preprocessed_data = to.train.xs.reset_index(drop=True)

# Check the preprocessed data
preprocessed_data.head()


# Aggregate peptide data by visit_id, UniProt, and visit_month
peptide_agg = train_peptides.groupby(['visit_id', 'UniProt', 'visit_month']).agg({'PeptideAbundance': 'sum'}).reset_index()

# Merge aggregated peptide data with protein data
merged_protein_data = train_proteins.merge(peptide_agg, on=['visit_id', 'UniProt', 'visit_month'], how='left')

# Calculate the ratio of peptide abundance to NPX
merged_protein_data['Peptide_NPX_ratio'] = merged_protein_data['PeptideAbundance'] / merged_protein_data['NPX']

# Merge the protein-level data with the preprocessed clinical data
merged_data = preprocessed_data.merge(merged_protein_data, on=['patient_id', 'visit_month'])
